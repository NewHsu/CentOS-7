# LVM  Snapshot

## LVM-进阶-Snapshot
我们最常用的就是基于卷管理的快照—LVM snapshot。要提醒一点是，以下内容是针对安装了LVM的系统。写时复制在文件系统和磁盘I/O之间增加了一层COW层。变成了下面这个样子：
file I/0 —&gt; filesystem — &gt;COW –&gt; block I /O
采取COW实现方式时，snapshot的大小并不需要和原始卷一样大，其大小仅仅只需要考虑两个方面：从shapshot创建到释放这段时间内，估计块的改变量有多大;数据更新的频率。一旦 snapshot的空间记录满了原始卷块变换的信息，那么这个snapshot立刻被释放，就无法使用，从而导致这个snapshot无效。所以，一定要在snapshot的生命周期里，做完你需要做得事情。

通过使用lvm的快照我们可以轻松的备份数据，由于snapshot和源lvm的关系，snapshot只能够临时使用，不能脱离源lvm而存在；因此做到数据的万无一失，我们可以在snapshot的基础上进行某时间点的备份或其他备份操作，这样既不会影响原始数据也能够达到备份的需求。

如果我们在创建快照后意外地删除了无论什么文件，我们没有必要担心，因为快照里包含了我们所删除的文件的原始文件。创建快照时，很有可能文件已经存在了。不要改变快照卷，保持创建时的样子，因为它用于快速恢复。
快照不可以用于备份选项。备份是某些数据的基础副本，因此我们不能使用快照作为备份的一个选择

## LVM snapshot原理
> LVM对LV提供的快照功能，只对LVM有效。
* 当一个snapshot创建的时候，仅拷贝原始卷里数据的元数据(meta-data)。创建的时候，并不会有数据的物理拷贝，因此snapshot的创建几乎是实时的，当原始卷上有写操作执行时，snapshot跟踪原始卷块的改变，这个时候原始卷上将要改变的数据在改变之前被拷贝到snapshot预留的空间里，因此这个原理的实现叫做写时复制(copy-on-write)。
* 在写操作写入块之前，将原始数据移动到?snapshot空间里，这样就保证了所有的数据在snapshot创建时保持一致。而对于snapshot的读操作，如果是读取数据块是没有修改过的，那么会将读操作直接重定向到原始卷上，如果是要读取已经修改过的块，那么就读取拷贝到snapshot中的块。
* 创建snapshot的大小并不需要和原始卷一样大，其大小仅仅只需要考虑两个方面：从shapshot创建到释放这段时间内，估计块的改变量有多大;数据更新的频率。一旦snapshot的空间记录满了原始卷块变换的信息，那么这个snapshot立刻被释放，从而无法使用，从而导致这个snapshot无效。

### 原理-创建快照
在快照创建的时候，仅拷贝原始卷里数据的元数据(meta-data)，并生成位图记录原始卷的块数据变化。

